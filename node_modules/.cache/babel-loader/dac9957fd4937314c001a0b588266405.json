{"ast":null,"code":"import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import _objectSpread from\"/home/amil/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/amil/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/amil/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/amil/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";/* eslint-disable react/require-default-props */ /* eslint-disable jsx-a11y/click-events-have-key-events */ /* eslint-disable jsx-a11y/no-static-element-interactions */import React from'react';import Timer from'react-compound-timer';import{useTranslation}from'react-i18next';// Utils\nimport RecorderService from'helper/audio/RecorderService';import FileHelper from'helper/fileHelper';import{getDuration}from'helper/getDuration';// Modals\nimport RecordErrorModal from'modals/RecordErrorModal';// Images\nimport StartSVG from\"assets/icons/start.svg\";import StopSVG from\"assets/icons/stop.svg\";// Styles\nimport{MicRecorderContainer,MicRecorderButton,MicRecorderStartImage,MicRecorderStopImage,MicRecorderTimerContainer,MicRecorderTimerReleaseTextContainer,MicRecorderTextP,MicButtonsContainer,MicNote,MicButtonWithText}from'./style';var baseConfig={usingMediaRecorder:false,sampleRate:48000,manualEncoderId:'wav',// wav / mp3 / flac\nprocessorBufferSize:2048// 4096 flac / 2048 wav\n};var MicRecorder=function MicRecorder(_ref){var _ref$className=_ref.className,className=_ref$className===void 0?'':_ref$className,_ref$maxTimeInSeconds=_ref.maxTimeInSeconds,maxTimeInSeconds=_ref$maxTimeInSeconds===void 0?30:_ref$maxTimeInSeconds,onNewRecord=_ref.onNewRecord,_ref$delay=_ref.delay,delay=_ref$delay===void 0?500:_ref$delay,recordingFile=_ref.recordingFile;// Hooks\nvar _useTranslation=useTranslation(),t=_useTranslation.t;// Refs\nvar recordingService=React.useRef();var audioSamples=React.useRef(0);var timerRef=React.useRef();var timeout=React.useRef();var target=React.useRef();// States\nvar _React$useState=React.useState(true),_React$useState2=_slicedToArray(_React$useState,2),micAllowed=_React$useState2[0],setMicAllowed=_React$useState2[1];var _React$useState3=React.useState(),_React$useState4=_slicedToArray(_React$useState3,2),recordingInProgress=_React$useState4[0],setRecordingInProgress=_React$useState4[1];var _React$useState5=React.useState(false),_React$useState6=_slicedToArray(_React$useState5,2),showReleaseText=_React$useState6[0],setShowReleaseText=_React$useState6[1];var _React$useState7=React.useState(false),_React$useState8=_slicedToArray(_React$useState7,2),showShortRecordingText=_React$useState8[0],setShowShortRecordingText=_React$useState8[1];var _React$useState9=React.useState(false),_React$useState10=_slicedToArray(_React$useState9,2),longPressTriggered=_React$useState10[0],setLongPressTriggered=_React$useState10[1];// Handlers\nvar onAudioProcess=React.useCallback(function(e){audioSamples.current+=1;var _e$detail=e.detail,inputBuffer=_e$detail.inputBuffer,outputBuffer=_e$detail.outputBuffer;for(var channel=0;channel<outputBuffer.numberOfChannels;channel+=1){var inputData=inputBuffer.getChannelData(channel);var outputData=outputBuffer.getChannelData(channel);// Each sample\nfor(var sample=0;sample<inputBuffer.length;sample+=1){outputData[sample]=inputData[sample];}}},[]);var onNewRecording=React.useCallback(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var detail,recording,blob,fileName,file,humanReadableSize;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:detail=e.detail;recording=detail.recording;_context.next=4;return fetch(recording.blobUrl).then(function(r){return r.blob();});case 4:blob=_context.sent;fileName=\"Filename.\".concat(baseConfig.manualEncoderId);file=FileHelper.blobToFile(blob,fileName);humanReadableSize=FileHelper.sizeAsHuman(file.size,true);onNewRecord(file,humanReadableSize);case 9:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref2.apply(this,arguments);};}(),[onNewRecord]);// Effects\nReact.useEffect(function(){recordingService.current=new RecorderService(_objectSpread(_objectSpread({},baseConfig),{},{onRecording:onNewRecording,onAudioProcesss:onAudioProcess}));var userMediaConstraints={audio:{echoCancellation:recordingService.current.config.enableEchoCancellation}};navigator.mediaDevices.getUserMedia(userMediaConstraints).then(function(){setMicAllowed(true);}).catch(function(){setMicAllowed(false);});if(recordingFile){var _file=recordingFile;if(_file.size){var audio=new Audio(URL.createObjectURL(_file));audio.load();var listenerFn=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:audio.removeEventListener('loadedmetadata',listenerFn);getDuration(audio,true).then(function(result){var _timerRef$current;(_timerRef$current=timerRef.current)===null||_timerRef$current===void 0?void 0:_timerRef$current.setTime(result*1000);});case 2:case\"end\":return _context2.stop();}}},_callee2);}));return function listenerFn(){return _ref3.apply(this,arguments);};}();audio.addEventListener('loadedmetadata',listenerFn);}}return function(){if(recordingService.current){recordingService.current.cleanup();}};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);// Handlers\nvar handleStartRecording=React.useCallback(function(){if(recordingService.current){audioSamples.current=0;recordingService.current.startRecording().then(function(){setRecordingInProgress(true);setShowShortRecordingText(false);if(timerRef.current){var _timerRef$current2;timerRef.current.reset();(_timerRef$current2=timerRef.current)===null||_timerRef$current2===void 0?void 0:_timerRef$current2.setTime(0);timerRef.current.start();}}).catch(function(error){return console.error('ERROR',error);});}},[]);var handleStopRecording=React.useCallback(function(){if(recordingService.current){recordingService.current.stopRecording();setRecordingInProgress(false);if(timerRef.current){if(timerRef.current.getTime()/1000<2){setShowShortRecordingText(true);}timerRef.current.stop();}}},[]);var handleFormatValue=React.useCallback(function(value){return value<10?\"0\".concat(value):value;},[]);var preventDefault=function preventDefault(event){if(!('touches'in event))event.preventDefault();};var handleStartLongPress=React.useCallback(function(event){if(event.target){event.target.addEventListener('touchend',preventDefault,{passive:false});target.current=event.target;}timeout.current=setTimeout(function(){setShowReleaseText(true);setLongPressTriggered(true);setShowShortRecordingText(false);},delay);},[delay]);var handleEndLongPress=React.useCallback(function(){if(timeout.current){clearTimeout(timeout.current);}if(longPressTriggered){setShowReleaseText(false);}setLongPressTriggered(false);if(target.current){target.current.removeEventListener('touchend',preventDefault);}},[longPressTriggered]);return/*#__PURE__*/_jsxs(MicRecorderContainer,{className:className,children:[/*#__PURE__*/_jsxs(MicRecorderTimerReleaseTextContainer,{children:[!showShortRecordingText&&/*#__PURE__*/_jsx(MicRecorderTextP,{show:showReleaseText,children:recordingInProgress?t('recordingsIntroduction:releaseButtonStop'):t('recordingsIntroduction:releaseButtonStart')}),/*#__PURE__*/_jsx(RecordErrorModal,{isOpen:showShortRecordingText,modalTitle:\"Oops.\",onConfirm:handleStartRecording,children:t('recordingsIntroduction:shortRecording')})]}),/*#__PURE__*/_jsx(MicRecorderTimerContainer,{children:/*#__PURE__*/_jsxs(Timer,{ref:timerRef,startImmediately:false,checkpoints:[{time:maxTimeInSeconds*1000,callback:handleStopRecording}],children:[/*#__PURE__*/_jsx(Timer.Minutes,{}),\":\",/*#__PURE__*/_jsx(Timer.Seconds,{formatValue:handleFormatValue})]})}),/*#__PURE__*/_jsxs(MicButtonsContainer,{children:[/*#__PURE__*/_jsxs(MicButtonWithText,{children:[/*#__PURE__*/_jsx(MicRecorderButton,{disabled:!micAllowed||recordingInProgress,onClick:handleStartRecording,onMouseDown:handleStartLongPress,onMouseUp:handleEndLongPress,onTouchStart:handleStartLongPress,onTouchEnd:handleEndLongPress,onMouseLeave:handleEndLongPress,children:/*#__PURE__*/_jsx(MicRecorderStartImage,{src:StartSVG,alt:\"Start\"})}),/*#__PURE__*/_jsx(MicNote,{children:t('recordingsIntroduction:recordCough.record')})]}),/*#__PURE__*/_jsxs(MicButtonWithText,{children:[/*#__PURE__*/_jsx(MicRecorderButton,{disabled:!micAllowed||!recordingInProgress,onClick:handleStopRecording,onMouseDown:handleStartLongPress,onMouseUp:handleEndLongPress,onTouchStart:handleStartLongPress,onTouchEnd:handleEndLongPress,onMouseLeave:handleEndLongPress,children:/*#__PURE__*/_jsx(MicRecorderStopImage,{src:StopSVG,alt:\"Stop\"})}),/*#__PURE__*/_jsx(MicNote,{children:t('recordingsIntroduction:recordCough.stop')})]})]})]});};export default/*#__PURE__*/React.memo(MicRecorder);","map":null,"metadata":{},"sourceType":"module"}