{"ast":null,"code":"import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import _objectSpread from\"/Users/arcsec/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/arcsec/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/arcsec/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/arcsec/virufy-demo.github.io/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";/* eslint-disable react/require-default-props */ /* eslint-disable jsx-a11y/click-events-have-key-events */ /* eslint-disable jsx-a11y/no-static-element-interactions */import React from'react';import Timer from'react-compound-timer';import{useTranslation}from'react-i18next';// Utils\nimport RecorderService from'helper/audio/RecorderService';import FileHelper from'helper/fileHelper';import{getDuration}from'helper/getDuration';// Modals\nimport RecordErrorModal from'modals/RecordErrorModal';// Images\nimport StartSVG from\"assets/icons/start.svg\";import StopSVG from\"assets/icons/stop.svg\";// Styles\nimport{MicRecorderContainer,MicRecorderButton,MicRecorderStartImage,MicRecorderStopImage,MicRecorderTimerContainer,MicRecorderTimerReleaseTextContainer,MicRecorderTextP,MicButtonsContainer,MicNote,MicButtonWithText}from'./style';var baseConfig={usingMediaRecorder:false,sampleRate:48000,manualEncoderId:'wav',// wav / mp3 / flac\nprocessorBufferSize:2048// 4096 flac / 2048 wav\n};var MicRecorder=function MicRecorder(_ref){var _ref$className=_ref.className,className=_ref$className===void 0?'':_ref$className,_ref$maxTimeInSeconds=_ref.maxTimeInSeconds,maxTimeInSeconds=_ref$maxTimeInSeconds===void 0?30:_ref$maxTimeInSeconds,onNewRecord=_ref.onNewRecord,_ref$delay=_ref.delay,delay=_ref$delay===void 0?500:_ref$delay,recordingFile=_ref.recordingFile;// Hooks\nvar _useTranslation=useTranslation(),t=_useTranslation.t;// Refs\nvar recordingService=React.useRef();var audioSamples=React.useRef(0);var timerRef=React.useRef();var timeout=React.useRef();var target=React.useRef();// States\nvar _React$useState=React.useState(true),_React$useState2=_slicedToArray(_React$useState,2),micAllowed=_React$useState2[0],setMicAllowed=_React$useState2[1];var _React$useState3=React.useState(),_React$useState4=_slicedToArray(_React$useState3,2),recordingInProgress=_React$useState4[0],setRecordingInProgress=_React$useState4[1];var _React$useState5=React.useState(false),_React$useState6=_slicedToArray(_React$useState5,2),showReleaseText=_React$useState6[0],setShowReleaseText=_React$useState6[1];var _React$useState7=React.useState(false),_React$useState8=_slicedToArray(_React$useState7,2),showShortRecordingText=_React$useState8[0],setShowShortRecordingText=_React$useState8[1];var _React$useState9=React.useState(false),_React$useState10=_slicedToArray(_React$useState9,2),longPressTriggered=_React$useState10[0],setLongPressTriggered=_React$useState10[1];// Handlers\nvar onAudioProcess=React.useCallback(function(e){audioSamples.current+=1;var _e$detail=e.detail,inputBuffer=_e$detail.inputBuffer,outputBuffer=_e$detail.outputBuffer;for(var channel=0;channel<outputBuffer.numberOfChannels;channel+=1){var inputData=inputBuffer.getChannelData(channel);var outputData=outputBuffer.getChannelData(channel);// Each sample\nfor(var sample=0;sample<inputBuffer.length;sample+=1){outputData[sample]=inputData[sample];}}},[]);var onNewRecording=React.useCallback(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var detail,recording,blob,fileName,file,humanReadableSize;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:detail=e.detail;recording=detail.recording;_context.next=4;return fetch(recording.blobUrl).then(function(r){return r.blob();});case 4:blob=_context.sent;fileName=\"Filename.\".concat(baseConfig.manualEncoderId);file=FileHelper.blobToFile(blob,fileName);humanReadableSize=FileHelper.sizeAsHuman(file.size,true);onNewRecord(file,humanReadableSize);case 9:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref2.apply(this,arguments);};}(),[onNewRecord]);// Effects\nReact.useEffect(function(){recordingService.current=new RecorderService(_objectSpread(_objectSpread({},baseConfig),{},{onRecording:onNewRecording,onAudioProcesss:onAudioProcess}));var userMediaConstraints={audio:{echoCancellation:recordingService.current.config.enableEchoCancellation}};navigator.mediaDevices.getUserMedia(userMediaConstraints).then(function(){setMicAllowed(true);}).catch(function(){setMicAllowed(false);});if(recordingFile){var _file=recordingFile;if(_file.size){var audio=new Audio(URL.createObjectURL(_file));audio.load();var listenerFn=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:audio.removeEventListener('loadedmetadata',listenerFn);getDuration(audio,true).then(function(result){var _timerRef$current;(_timerRef$current=timerRef.current)===null||_timerRef$current===void 0?void 0:_timerRef$current.setTime(result*1000);});case 2:case\"end\":return _context2.stop();}}},_callee2);}));return function listenerFn(){return _ref3.apply(this,arguments);};}();audio.addEventListener('loadedmetadata',listenerFn);}}return function(){if(recordingService.current){recordingService.current.cleanup();}};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);// Handlers\nvar handleStartRecording=React.useCallback(function(){if(recordingService.current){audioSamples.current=0;recordingService.current.startRecording().then(function(){setRecordingInProgress(true);setShowShortRecordingText(false);if(timerRef.current){var _timerRef$current2;timerRef.current.reset();(_timerRef$current2=timerRef.current)===null||_timerRef$current2===void 0?void 0:_timerRef$current2.setTime(0);timerRef.current.start();}}).catch(function(error){return console.error('ERROR',error);});}},[]);var handleStopRecording=React.useCallback(function(){if(recordingService.current){recordingService.current.stopRecording();setRecordingInProgress(false);if(timerRef.current){if(timerRef.current.getTime()/1000<2){setShowShortRecordingText(true);}timerRef.current.stop();}}},[]);var handleFormatValue=React.useCallback(function(value){return value<10?\"0\".concat(value):value;},[]);var preventDefault=function preventDefault(event){if(!('touches'in event))event.preventDefault();};var handleStartLongPress=React.useCallback(function(event){if(event.target){event.target.addEventListener('touchend',preventDefault,{passive:false});target.current=event.target;}timeout.current=setTimeout(function(){setShowReleaseText(true);setLongPressTriggered(true);setShowShortRecordingText(false);},delay);},[delay]);var handleEndLongPress=React.useCallback(function(){if(timeout.current){clearTimeout(timeout.current);}if(longPressTriggered){setShowReleaseText(false);}setLongPressTriggered(false);if(target.current){target.current.removeEventListener('touchend',preventDefault);}},[longPressTriggered]);return/*#__PURE__*/_jsxs(MicRecorderContainer,{className:className,children:[/*#__PURE__*/_jsxs(MicRecorderTimerReleaseTextContainer,{children:[!showShortRecordingText&&/*#__PURE__*/_jsx(MicRecorderTextP,{show:showReleaseText,children:recordingInProgress?t('recordingsIntroduction:releaseButtonStop'):t('recordingsIntroduction:releaseButtonStart')}),/*#__PURE__*/_jsx(RecordErrorModal,{isOpen:showShortRecordingText,modalTitle:\"Oops.\",onConfirm:handleStartRecording,children:t('recordingsIntroduction:shortRecording')})]}),/*#__PURE__*/_jsx(MicRecorderTimerContainer,{children:/*#__PURE__*/_jsxs(Timer,{ref:timerRef,startImmediately:false,checkpoints:[{time:maxTimeInSeconds*1000,callback:handleStopRecording}],children:[/*#__PURE__*/_jsx(Timer.Minutes,{}),\":\",/*#__PURE__*/_jsx(Timer.Seconds,{formatValue:handleFormatValue})]})}),/*#__PURE__*/_jsxs(MicButtonsContainer,{children:[/*#__PURE__*/_jsxs(MicButtonWithText,{children:[/*#__PURE__*/_jsx(MicRecorderButton,{disabled:!micAllowed||recordingInProgress,onClick:handleStartRecording,onMouseDown:handleStartLongPress,onMouseUp:handleEndLongPress,onTouchStart:handleStartLongPress,onTouchEnd:handleEndLongPress,onMouseLeave:handleEndLongPress,children:/*#__PURE__*/_jsx(MicRecorderStartImage,{src:StartSVG,alt:\"Start\"})}),/*#__PURE__*/_jsx(MicNote,{children:t('recordingsIntroduction:recordCough.record')})]}),/*#__PURE__*/_jsxs(MicButtonWithText,{children:[/*#__PURE__*/_jsx(MicRecorderButton,{disabled:!micAllowed||!recordingInProgress,onClick:handleStopRecording,onMouseDown:handleStartLongPress,onMouseUp:handleEndLongPress,onTouchStart:handleStartLongPress,onTouchEnd:handleEndLongPress,onMouseLeave:handleEndLongPress,children:/*#__PURE__*/_jsx(MicRecorderStopImage,{src:StopSVG,alt:\"Stop\"})}),/*#__PURE__*/_jsx(MicNote,{children:t('recordingsIntroduction:recordCough.stop')})]})]})]});};export default/*#__PURE__*/React.memo(MicRecorder);","map":{"version":3,"sources":["/Users/arcsec/virufy-demo.github.io/src/components/MicRecorder/MicRecorder.tsx"],"names":["React","Timer","useTranslation","RecorderService","FileHelper","getDuration","RecordErrorModal","MicRecorderContainer","MicRecorderButton","MicRecorderStartImage","MicRecorderStopImage","MicRecorderTimerContainer","MicRecorderTimerReleaseTextContainer","MicRecorderTextP","MicButtonsContainer","MicNote","MicButtonWithText","baseConfig","usingMediaRecorder","sampleRate","manualEncoderId","processorBufferSize","MicRecorder","className","maxTimeInSeconds","onNewRecord","delay","recordingFile","t","recordingService","useRef","audioSamples","timerRef","timeout","target","useState","micAllowed","setMicAllowed","recordingInProgress","setRecordingInProgress","showReleaseText","setShowReleaseText","showShortRecordingText","setShowShortRecordingText","longPressTriggered","setLongPressTriggered","onAudioProcess","useCallback","e","current","detail","inputBuffer","outputBuffer","channel","numberOfChannels","inputData","getChannelData","outputData","sample","length","onNewRecording","recording","fetch","blobUrl","then","r","blob","fileName","file","blobToFile","humanReadableSize","sizeAsHuman","size","useEffect","onRecording","onAudioProcesss","userMediaConstraints","audio","echoCancellation","config","enableEchoCancellation","navigator","mediaDevices","getUserMedia","catch","Audio","URL","createObjectURL","load","listenerFn","removeEventListener","result","setTime","addEventListener","cleanup","handleStartRecording","startRecording","reset","start","error","console","handleStopRecording","stopRecording","getTime","stop","handleFormatValue","value","preventDefault","event","handleStartLongPress","passive","setTimeout","handleEndLongPress","clearTimeout","time","callback","StartSVG","StopSVG","memo"],"mappings":"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","sourcesContent":["/* eslint-disable react/require-default-props */\n/* eslint-disable jsx-a11y/click-events-have-key-events */\n/* eslint-disable jsx-a11y/no-static-element-interactions */\nimport React from 'react';\nimport Timer from 'react-compound-timer';\nimport { useTranslation } from 'react-i18next';\n\n// Utils\nimport RecorderService from 'helper/audio/RecorderService';\nimport FileHelper from 'helper/fileHelper';\nimport { getDuration } from 'helper/getDuration';\n\n// Modals\nimport RecordErrorModal from 'modals/RecordErrorModal';\n\n// Images\nimport StartSVG from 'assets/icons/start.svg';\nimport StopSVG from 'assets/icons/stop.svg';\n\n// Styles\nimport {\n  MicRecorderContainer,\n  MicRecorderButton,\n  MicRecorderStartImage,\n  MicRecorderStopImage,\n  MicRecorderTimerContainer,\n  MicRecorderTimerReleaseTextContainer,\n  MicRecorderTextP,\n  MicButtonsContainer,\n  MicNote,\n  MicButtonWithText,\n} from './style';\n\ninterface MicRecorderProps {\n  className?: string;\n  maxTimeInSeconds?: number;\n  onNewRecord: (file: File, humanReadableSize: string) => void;\n  delay?: number;\n  recordingFile: any;\n}\n\nconst baseConfig = {\n  usingMediaRecorder: false,\n  sampleRate: 48000,\n  manualEncoderId: 'wav', // wav / mp3 / flac\n  processorBufferSize: 2048, // 4096 flac / 2048 wav\n};\n\nexport interface RecorderServiceType {\n  config: {\n    broadcastAudioProcessEvents: boolean; // default: false\n    createAnalyserNode: boolean; // default: false\n    createDynamicsCompressorNode: boolean; // default: false\n    forceScriptProcessor: false; // default: false\n    manualEncoderId: string; // default: 'wav'\n    micGain: number; // default: 1.0\n    processorBufferSize: number; // default: 2048\n    stopTracksAndCloseCtxWhenFinished: boolean; // default: true\n    usingMediaRecorder: boolean; // default: typeof window.MediaRecorder !== 'undefined'\n    enableEchoCancellation: boolean; // default: true\n    sampleRate: number; // default: 44100\n  };\n  em: DocumentFragment;\n  startRecording: (timeslice?: number) => Promise<void>;\n  stopRecording: () => void;\n  cleanup: () => void;\n}\n\nconst MicRecorder = ({\n  className = '',\n  maxTimeInSeconds = 30, // 30 segs\n  onNewRecord,\n  delay = 500, // 500ms\n  recordingFile,\n}: MicRecorderProps) => {\n  // Hooks\n  const { t } = useTranslation();\n\n  // Refs\n  const recordingService = React.useRef<RecorderServiceType>();\n  const audioSamples = React.useRef<number>(0);\n  const timerRef = React.useRef<any>();\n  const timeout = React.useRef<NodeJS.Timeout>();\n  const target = React.useRef<HTMLButtonElement>();\n\n  // States\n  const [micAllowed, setMicAllowed] = React.useState<boolean>(true);\n  const [recordingInProgress, setRecordingInProgress] = React.useState<boolean>();\n  const [showReleaseText, setShowReleaseText] = React.useState<boolean>(false);\n  const [showShortRecordingText, setShowShortRecordingText] = React.useState<boolean>(false);\n  const [longPressTriggered, setLongPressTriggered] = React.useState<boolean>(false);\n\n  // Handlers\n  const onAudioProcess = React.useCallback((e: any) => {\n    audioSamples.current += 1;\n    const { inputBuffer, outputBuffer } = e.detail;\n    for (let channel = 0; channel < outputBuffer.numberOfChannels; channel += 1) {\n      const inputData = inputBuffer.getChannelData(channel);\n      const outputData = outputBuffer.getChannelData(channel);\n      // Each sample\n      for (let sample = 0; sample < inputBuffer.length; sample += 1) {\n        outputData[sample] = inputData[sample];\n      }\n    }\n  }, []);\n\n  const onNewRecording = React.useCallback(async (e: any) => {\n    const { detail } = e;\n    const { recording } = detail;\n    const blob = await fetch(recording.blobUrl).then(r => r.blob());\n    const fileName = `Filename.${baseConfig.manualEncoderId}`;\n\n    const file = FileHelper.blobToFile(blob, fileName);\n    const humanReadableSize = FileHelper.sizeAsHuman(file.size, true);\n\n    onNewRecord(file, humanReadableSize);\n  }, [onNewRecord]);\n\n  // Effects\n  React.useEffect(() => {\n    recordingService.current = new RecorderService({\n      ...baseConfig,\n      onRecording: onNewRecording,\n      onAudioProcesss: onAudioProcess,\n    }) as RecorderServiceType;\n\n    const userMediaConstraints = {\n      audio: {\n        echoCancellation: recordingService.current.config.enableEchoCancellation,\n      },\n    };\n    navigator.mediaDevices.getUserMedia(userMediaConstraints)\n      .then(() => {\n        setMicAllowed(true);\n      })\n      .catch(() => {\n        setMicAllowed(false);\n      });\n\n    if (recordingFile) {\n      const file = recordingFile as File;\n      if (file.size) {\n        const audio = new Audio(URL.createObjectURL(file));\n        audio.load();\n        const listenerFn = async () => {\n          audio.removeEventListener('loadedmetadata', listenerFn);\n          getDuration(audio, true).then(result => {\n            timerRef.current?.setTime(result * 1000);\n          });\n        };\n        audio.addEventListener('loadedmetadata', listenerFn);\n      }\n    }\n\n    return () => {\n      if (recordingService.current) {\n        recordingService.current.cleanup();\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Handlers\n  const handleStartRecording = React.useCallback(() => {\n    if (recordingService.current) {\n      audioSamples.current = 0;\n      recordingService.current\n        .startRecording()\n        .then(() => {\n          setRecordingInProgress(true);\n          setShowShortRecordingText(false);\n          if (timerRef.current) {\n            timerRef.current.reset();\n            timerRef.current?.setTime(0);\n            timerRef.current.start();\n          }\n        })\n        .catch((error: any) => console.error('ERROR', error));\n    }\n  }, []);\n\n  const handleStopRecording = React.useCallback(() => {\n    if (recordingService.current) {\n      recordingService.current.stopRecording();\n      setRecordingInProgress(false);\n      if (timerRef.current) {\n        if (timerRef.current.getTime() / 1000 < 2) {\n          setShowShortRecordingText(true);\n        }\n        timerRef.current.stop();\n      }\n    }\n  }, []);\n\n  const handleFormatValue = React.useCallback((value: number) => (value < 10 ? `0${value}` : value), []);\n\n  const preventDefault = (event: any) => {\n    if (!('touches' in event)) event.preventDefault();\n  };\n\n  const handleStartLongPress = React.useCallback(\n    event => {\n      if (event.target) {\n        event.target.addEventListener('touchend', preventDefault, {\n          passive: false,\n        });\n        target.current = event.target;\n      }\n      timeout.current = setTimeout(() => {\n        setShowReleaseText(true);\n        setLongPressTriggered(true);\n        setShowShortRecordingText(false);\n      }, delay);\n    },\n    [delay],\n  );\n\n  const handleEndLongPress = React.useCallback(() => {\n    if (timeout.current) {\n      clearTimeout(timeout.current);\n    }\n    if (longPressTriggered) {\n      setShowReleaseText(false);\n    }\n    setLongPressTriggered(false);\n    if (target.current) {\n      target.current.removeEventListener('touchend', preventDefault);\n    }\n  },\n  [longPressTriggered]);\n\n  return (\n    <MicRecorderContainer className={className}>\n      <MicRecorderTimerReleaseTextContainer>\n        {!showShortRecordingText\n          && (\n            <MicRecorderTextP\n              show={showReleaseText}\n            >\n              {recordingInProgress ? t('recordingsIntroduction:releaseButtonStop') : t('recordingsIntroduction:releaseButtonStart')}\n            </MicRecorderTextP>\n          )}\n        <RecordErrorModal\n          isOpen={showShortRecordingText}\n          modalTitle=\"Oops.\"\n          onConfirm={handleStartRecording}\n        >\n          {t('recordingsIntroduction:shortRecording')}\n        </RecordErrorModal>\n      </MicRecorderTimerReleaseTextContainer>\n      <MicRecorderTimerContainer>\n        <Timer\n          ref={timerRef}\n          startImmediately={false}\n          checkpoints={[\n            {\n              time: maxTimeInSeconds * 1000,\n              callback: handleStopRecording,\n            },\n          ]}\n        >\n          <Timer.Minutes />\n          :\n          <Timer.Seconds formatValue={handleFormatValue} />\n        </Timer>\n      </MicRecorderTimerContainer>\n      <MicButtonsContainer>\n        <MicButtonWithText>\n          <MicRecorderButton\n            disabled={!micAllowed || recordingInProgress}\n            onClick={handleStartRecording}\n            onMouseDown={handleStartLongPress}\n            onMouseUp={handleEndLongPress}\n            onTouchStart={handleStartLongPress}\n            onTouchEnd={handleEndLongPress}\n            onMouseLeave={handleEndLongPress}\n          >\n            <MicRecorderStartImage\n              src={StartSVG}\n              alt=\"Start\"\n            />\n          </MicRecorderButton>\n          <MicNote>{t('recordingsIntroduction:recordCough.record')}</MicNote>\n        </MicButtonWithText>\n        <MicButtonWithText>\n          <MicRecorderButton\n            disabled={!micAllowed || !recordingInProgress}\n            onClick={handleStopRecording}\n            onMouseDown={handleStartLongPress}\n            onMouseUp={handleEndLongPress}\n            onTouchStart={handleStartLongPress}\n            onTouchEnd={handleEndLongPress}\n            onMouseLeave={handleEndLongPress}\n          >\n            <MicRecorderStopImage\n              src={StopSVG}\n              alt=\"Stop\"\n            />\n          </MicRecorderButton>\n          <MicNote>{t('recordingsIntroduction:recordCough.stop')}</MicNote>\n        </MicButtonWithText>\n      </MicButtonsContainer>\n    </MicRecorderContainer>\n  );\n};\n\nexport default React.memo(MicRecorder);\n"]},"metadata":{},"sourceType":"module"}